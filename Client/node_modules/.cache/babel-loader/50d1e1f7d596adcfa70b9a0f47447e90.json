{"ast":null,"code":"import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import _objectSpread from\"H:/Mern Stack Projects/WebApp/Server/Client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"H:/Mern Stack Projects/WebApp/Server/Client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useRef,useCallback}from'react';import{useSelector,useDispatch}from'react-redux';import Avatar from'../Avatar';import{GLOBALTYPES}from'../../redux/actions/globalTypes';import{addMessage}from'../../redux/actions/messageAction';import RingRing from'../../audio/ringring.mp3';var CallModal=function CallModal(){var _useSelector=useSelector(function(state){return state;}),call=_useSelector.call,auth=_useSelector.auth,peer=_useSelector.peer,socket=_useSelector.socket,theme=_useSelector.theme;var dispatch=useDispatch();var _useState=useState(0),_useState2=_slicedToArray(_useState,2),hours=_useState2[0],setHours=_useState2[1];var _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),mins=_useState4[0],setMins=_useState4[1];var _useState5=useState(0),_useState6=_slicedToArray(_useState5,2),second=_useState6[0],setSecond=_useState6[1];var _useState7=useState(0),_useState8=_slicedToArray(_useState7,2),total=_useState8[0],setTotal=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),answer=_useState10[0],setAnswer=_useState10[1];var youVideo=useRef();var otherVideo=useRef();var _useState11=useState(null),_useState12=_slicedToArray(_useState11,2),tracks=_useState12[0],setTracks=_useState12[1];var _useState13=useState(null),_useState14=_slicedToArray(_useState13,2),newCall=_useState14[0],setNewCall=_useState14[1];// Set Time\nuseEffect(function(){var setTime=function setTime(){setTotal(function(t){return t+1;});setTimeout(setTime,1000);};setTime();return function(){return setTotal(0);};},[]);useEffect(function(){setSecond(total%60);setMins(parseInt(total/60));setHours(parseInt(total/3600));},[total]);// End Call\nvar addCallMessage=useCallback(function(call,times,disconnect){if(call.recipient!==auth.user._id||disconnect){var msg={sender:call.sender,recipient:call.recipient,text:'',media:[],call:{video:call.video,times:times},createdAt:new Date().toISOString()};dispatch(addMessage({msg:msg,auth:auth,socket:socket}));}},[auth,dispatch,socket]);var handleEndCall=function handleEndCall(){tracks&&tracks.forEach(function(track){return track.stop();});if(newCall)newCall.close();var times=answer?total:0;socket.emit('endCall',_objectSpread(_objectSpread({},call),{},{times:times}));addCallMessage(call,times);dispatch({type:GLOBALTYPES.CALL,payload:null});};useEffect(function(){if(answer){setTotal(0);}else{var timer=setTimeout(function(){socket.emit('endCall',_objectSpread(_objectSpread({},call),{},{times:0}));addCallMessage(call,0);dispatch({type:GLOBALTYPES.CALL,payload:null});},15000);return function(){return clearTimeout(timer);};}},[dispatch,answer,call,socket,addCallMessage]);useEffect(function(){socket.on('endCallToClient',function(data){tracks&&tracks.forEach(function(track){return track.stop();});if(newCall)newCall.close();addCallMessage(data,data.times);dispatch({type:GLOBALTYPES.CALL,payload:null});});return function(){return socket.off('endCallToClient');};},[socket,dispatch,tracks,addCallMessage,newCall]);// Stream Media\nvar openStream=function openStream(video){var config={audio:true,video:video};return navigator.mediaDevices.getUserMedia(config);};var playStream=function playStream(tag,stream){var video=tag;video.srcObject=stream;video.play();};// Answer Call\nvar handleAnswer=function handleAnswer(){openStream(call.video).then(function(stream){playStream(youVideo.current,stream);var track=stream.getTracks();setTracks(track);var newCall=peer.call(call.peerId,stream);newCall.on('stream',function(remoteStream){playStream(otherVideo.current,remoteStream);});setAnswer(true);setNewCall(newCall);});};useEffect(function(){peer.on('call',function(newCall){openStream(call.video).then(function(stream){if(youVideo.current){playStream(youVideo.current,stream);}var track=stream.getTracks();setTracks(track);newCall.answer(stream);newCall.on('stream',function(remoteStream){if(otherVideo.current){playStream(otherVideo.current,remoteStream);}});setAnswer(true);setNewCall(newCall);});});return function(){return peer.removeListener('call');};},[peer,call.video]);// Disconnect\nuseEffect(function(){socket.on('callerDisconnect',function(){tracks&&tracks.forEach(function(track){return track.stop();});if(newCall)newCall.close();var times=answer?total:0;addCallMessage(call,times,true);dispatch({type:GLOBALTYPES.CALL,payload:null});dispatch({type:GLOBALTYPES.ALERT,payload:{error:\"The \".concat(call.username,\" disconnect\")}});});return function(){return socket.off('callerDisconnect');};},[socket,tracks,dispatch,call,addCallMessage,answer,total,newCall]);// Play - Pause Audio\nvar playAudio=function playAudio(newAudio){newAudio.play();};var pauseAudio=function pauseAudio(newAudio){newAudio.pause();newAudio.currentTime=0;};useEffect(function(){var newAudio=new Audio(RingRing);if(answer){pauseAudio(newAudio);}else{playAudio(newAudio);}return function(){return pauseAudio(newAudio);};},[answer]);return/*#__PURE__*/_jsxs(\"div\",{className:\"call_modal\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"call_box\",style:{display:answer&&call.video?'none':'flex'},children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",style:{padding:'40px 0'},children:[/*#__PURE__*/_jsx(Avatar,{src:call.avatar,size:\"supper-avatar\"}),/*#__PURE__*/_jsx(\"h4\",{children:call.username}),/*#__PURE__*/_jsx(\"h6\",{children:call.fullname}),answer?/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"span\",{children:hours.toString().length<2?'0'+hours:hours}),/*#__PURE__*/_jsx(\"span\",{children:\":\"}),/*#__PURE__*/_jsx(\"span\",{children:mins.toString().length<2?'0'+mins:mins}),/*#__PURE__*/_jsx(\"span\",{children:\":\"}),/*#__PURE__*/_jsx(\"span\",{children:second.toString().length<2?'0'+second:second})]}):/*#__PURE__*/_jsx(\"div\",{children:call.video?/*#__PURE__*/_jsx(\"span\",{children:\"calling video...\"}):/*#__PURE__*/_jsx(\"span\",{children:\"calling audio...\"})})]}),!answer&&/*#__PURE__*/_jsxs(\"div\",{className:\"timer\",children:[/*#__PURE__*/_jsx(\"small\",{children:mins.toString().length<2?'0'+mins:mins}),/*#__PURE__*/_jsx(\"small\",{children:\":\"}),/*#__PURE__*/_jsx(\"small\",{children:second.toString().length<2?'0'+second:second})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"call_menu\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"material-icons text-danger\",onClick:handleEndCall,children:\"call_end\"}),call.recipient===auth.user._id&&!answer&&/*#__PURE__*/_jsx(_Fragment,{children:call.video?/*#__PURE__*/_jsx(\"button\",{className:\"material-icons text-success\",onClick:handleAnswer,children:\"videocam\"}):/*#__PURE__*/_jsx(\"button\",{className:\"material-icons text-success\",onClick:handleAnswer,children:\"call\"})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"show_video\",style:{opacity:answer&&call.video?'1':'0',filter:theme?'invert(1)':'invert(0)'},children:[/*#__PURE__*/_jsx(\"video\",{ref:youVideo,className:\"you_video\",playsInline:true,muted:true}),/*#__PURE__*/_jsx(\"video\",{ref:otherVideo,className:\"other_video\",playsInline:true}),/*#__PURE__*/_jsxs(\"div\",{className:\"time_video\",children:[/*#__PURE__*/_jsx(\"span\",{children:hours.toString().length<2?'0'+hours:hours}),/*#__PURE__*/_jsx(\"span\",{children:\":\"}),/*#__PURE__*/_jsx(\"span\",{children:mins.toString().length<2?'0'+mins:mins}),/*#__PURE__*/_jsx(\"span\",{children:\":\"}),/*#__PURE__*/_jsx(\"span\",{children:second.toString().length<2?'0'+second:second})]}),/*#__PURE__*/_jsx(\"button\",{className:\"material-icons text-danger end_call\",onClick:handleEndCall,children:\"call_end\"})]})]});};export default CallModal;","map":{"version":3,"sources":["H:/Mern Stack Projects/WebApp/server/client/src/components/message/CallModal.js"],"names":["React","useState","useEffect","useRef","useCallback","useSelector","useDispatch","Avatar","GLOBALTYPES","addMessage","RingRing","CallModal","state","call","auth","peer","socket","theme","dispatch","hours","setHours","mins","setMins","second","setSecond","total","setTotal","answer","setAnswer","youVideo","otherVideo","tracks","setTracks","newCall","setNewCall","setTime","t","setTimeout","parseInt","addCallMessage","times","disconnect","recipient","user","_id","msg","sender","text","media","video","createdAt","Date","toISOString","handleEndCall","forEach","track","stop","close","emit","type","CALL","payload","timer","clearTimeout","on","data","off","openStream","config","audio","navigator","mediaDevices","getUserMedia","playStream","tag","stream","srcObject","play","handleAnswer","then","current","getTracks","peerId","remoteStream","removeListener","ALERT","error","username","playAudio","newAudio","pauseAudio","pause","currentTime","Audio","display","padding","avatar","fullname","toString","length","opacity","filter"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react'\nimport { useSelector, useDispatch } from 'react-redux'\nimport Avatar from '../Avatar'\nimport { GLOBALTYPES } from '../../redux/actions/globalTypes'\nimport { addMessage } from '../../redux/actions/messageAction'\nimport RingRing from '../../audio/ringring.mp3'\n\nconst CallModal = () => {\n    const { call, auth, peer, socket, theme } = useSelector(state => state)\n    const dispatch = useDispatch()\n\n    const [hours, setHours] = useState(0)\n    const [mins, setMins] = useState(0)\n    const [second, setSecond] = useState(0)\n    const [total, setTotal] = useState(0)\n\n    const [answer, setAnswer] = useState(false)\n    const youVideo = useRef()\n    const otherVideo = useRef()\n    const [tracks, setTracks] = useState(null)\n    const [newCall, setNewCall] = useState(null)\n\n    // Set Time\n    useEffect(() => {\n        const setTime = () => {\n            setTotal(t => t + 1)\n            setTimeout(setTime, 1000)\n        }\n        setTime()\n\n        return () => setTotal(0)\n    },[])\n\n    useEffect(() => {\n        setSecond(total%60)\n        setMins(parseInt(total/60))\n        setHours(parseInt(total/3600))\n    },[total])\n\n\n    // End Call\n    const addCallMessage = useCallback((call, times, disconnect) => {\n        if(call.recipient !== auth.user._id || disconnect){\n            const msg = {\n                sender: call.sender,\n                recipient: call.recipient,\n                text: '', \n                media: [],\n                call: {video: call.video, times},\n                createdAt: new Date().toISOString()\n            }\n            dispatch(addMessage({msg, auth, socket}))\n        }\n    },[auth, dispatch, socket])\n\n    const handleEndCall = () => {\n        tracks && tracks.forEach(track => track.stop())\n        if(newCall) newCall.close()\n        let times = answer ? total : 0\n        socket.emit('endCall', {...call, times})\n        \n        addCallMessage(call, times)\n        dispatch({type: GLOBALTYPES.CALL, payload: null })\n    }\n\n    useEffect(() => {\n        if(answer){\n            setTotal(0)\n        }else{\n            const timer = setTimeout(() => {\n                socket.emit('endCall', {...call, times: 0})\n                addCallMessage(call, 0)\n                dispatch({type: GLOBALTYPES.CALL, payload: null })\n            }, 15000)\n    \n            return () => clearTimeout(timer)\n        }\n        \n    },[dispatch, answer, call, socket, addCallMessage])\n\n    useEffect(() => {\n        socket.on('endCallToClient', data => {\n            tracks && tracks.forEach(track => track.stop())\n            if(newCall) newCall.close()\n            addCallMessage(data, data.times)\n            dispatch({ type: GLOBALTYPES.CALL, payload: null })\n        })\n\n        return () => socket.off('endCallToClient')\n    },[socket, dispatch, tracks, addCallMessage, newCall])\n\n\n    // Stream Media\n    const openStream = (video) => {\n        const config = { audio: true, video }\n        return navigator.mediaDevices.getUserMedia(config)\n    }\n\n    const playStream = (tag, stream) => {\n        let video = tag;\n        video.srcObject = stream;\n        video.play()\n    }\n\n    // Answer Call\n    const handleAnswer = () => {\n        openStream(call.video).then(stream => {\n            playStream(youVideo.current, stream)\n            const track = stream.getTracks()\n            setTracks(track)\n            \n            const newCall = peer.call(call.peerId, stream);\n            newCall.on('stream', function(remoteStream) {\n                playStream(otherVideo.current, remoteStream)\n            });\n            setAnswer(true)\n            setNewCall(newCall)\n        })\n    }\n\n    useEffect(() => {\n        peer.on('call', newCall => {\n            openStream(call.video).then(stream => {\n                if(youVideo.current){\n                    playStream(youVideo.current, stream)\n                }\n                const track = stream.getTracks()\n                setTracks(track)\n                \n                newCall.answer(stream)\n                newCall.on('stream', function(remoteStream) {\n                    if(otherVideo.current){\n                        playStream(otherVideo.current, remoteStream)\n                    }\n                });\n                setAnswer(true) \n                setNewCall(newCall)\n            })\n        })\n        return () => peer.removeListener('call')\n    },[peer, call.video])\n\n    // Disconnect\n    useEffect(() => {\n        socket.on('callerDisconnect', () => {\n            tracks && tracks.forEach(track => track.stop())\n            if(newCall) newCall.close()\n            let times = answer ? total : 0\n            addCallMessage(call, times, true)\n\n            dispatch({type: GLOBALTYPES.CALL, payload: null })\n\n            dispatch({\n                type: GLOBALTYPES.ALERT, \n                payload: {error: `The ${call.username} disconnect`} \n            })\n        })\n\n        return () => socket.off('callerDisconnect')\n    },[socket, tracks, dispatch, call, addCallMessage, answer, total, newCall])\n\n    // Play - Pause Audio\n    const playAudio = (newAudio) => {\n        newAudio.play()\n    }\n\n    const pauseAudio = (newAudio) => {\n        newAudio.pause()\n        newAudio.currentTime = 0\n    }\n\n    useEffect(() => {\n        let newAudio = new Audio(RingRing)\n        if(answer){\n            pauseAudio(newAudio)\n        }else{\n            playAudio(newAudio)\n        }\n\n        return () => pauseAudio(newAudio)\n    },[answer])\n\n\n    return (\n        <div className=\"call_modal\">\n            <div className=\"call_box\" style={{\n                display: (answer && call.video) ? 'none' : 'flex'\n            }} >\n\n                <div className=\"text-center\" style={{padding: '40px 0'}} >\n                    <Avatar src={call.avatar} size=\"supper-avatar\" />\n                    <h4>{call.username}</h4>\n                    <h6>{call.fullname}</h6>\n\n                    {\n                        answer \n                        ? <div>\n                            <span>{ hours.toString().length < 2 ? '0' + hours : hours }</span>\n                            <span>:</span>\n                            <span>{ mins.toString().length < 2 ? '0' + mins : mins }</span>\n                            <span>:</span>\n                            <span>{ second.toString().length < 2 ? '0' + second : second }</span>\n                        </div>\n                        : <div>\n                            {\n                                call.video\n                                ? <span>calling video...</span>\n                                : <span>calling audio...</span>\n                            }\n                        </div>\n                    }\n                    \n                </div>\n                \n                {\n                    !answer && \n                    <div className=\"timer\">\n                        <small>{ mins.toString().length < 2 ? '0' + mins : mins }</small>\n                        <small>:</small>\n                        <small>{ second.toString().length < 2 ? '0' + second : second }</small>\n                    </div>\n                }\n                \n\n                <div className=\"call_menu\">\n                    <button className=\"material-icons text-danger\"\n                    onClick={handleEndCall}>\n                        call_end\n                    </button>\n                    \n                    {\n                        (call.recipient === auth.user._id && !answer) &&\n                        <>\n                            {\n                                call.video\n                                ? <button className=\"material-icons text-success\"\n                                onClick={handleAnswer}>\n                                    videocam\n                                </button>\n                                : <button className=\"material-icons text-success\"\n                                onClick={handleAnswer}>\n                                    call\n                                </button>\n                            }\n                        </>\n                    }\n                    \n                </div>\n                \n            </div>\n\n            <div className=\"show_video\" style={{\n                opacity: (answer && call.video) ? '1' : '0',\n                filter: theme ? 'invert(1)' : 'invert(0)'\n            }} >\n\n                <video ref={youVideo} className=\"you_video\" playsInline muted />\n                <video ref={otherVideo} className=\"other_video\" playsInline />\n\n                <div className=\"time_video\">\n                    <span>{ hours.toString().length < 2 ? '0' + hours : hours }</span>\n                    <span>:</span>\n                    <span>{ mins.toString().length < 2 ? '0' + mins : mins }</span>\n                    <span>:</span>\n                    <span>{ second.toString().length < 2 ? '0' + second : second }</span>\n                </div>\n\n                <button className=\"material-icons text-danger end_call\"\n                onClick={handleEndCall}>\n                    call_end\n                </button>\n\n            </div>\n\n        </div>\n    )\n}\n\nexport default CallModal\n"]},"metadata":{},"sourceType":"module"}