{"ast":null,"code":"import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import _regeneratorRuntime from\"H:/Mern Stack Projects/WebApp/Server/Client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"H:/Mern Stack Projects/WebApp/Server/Client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"H:/Mern Stack Projects/WebApp/Server/Client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"H:/Mern Stack Projects/WebApp/Server/Client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useRef}from'react';import UserCard from'../UserCard';import{useSelector,useDispatch}from'react-redux';import{useParams,useHistory}from'react-router-dom';import MsgDisplay from'./MsgDisplay';import Icons from'../Icons';import{GLOBALTYPES}from'../../redux/actions/globalTypes';import{imageShow,videoShow}from'../../utils/mediaShow';import{imageUpload}from'../../utils/imageUpload';import{addMessage,getMessages,loadMoreMessages,deleteConversation}from'../../redux/actions/messageAction';import LoadIcon from'../../images/loading.gif';var RightSide=function RightSide(){var _useSelector=useSelector(function(state){return state;}),auth=_useSelector.auth,message=_useSelector.message,theme=_useSelector.theme,socket=_useSelector.socket,peer=_useSelector.peer;var dispatch=useDispatch();var _useParams=useParams(),id=_useParams.id;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),user=_useState2[0],setUser=_useState2[1];var _useState3=useState(''),_useState4=_slicedToArray(_useState3,2),text=_useState4[0],setText=_useState4[1];var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),media=_useState6[0],setMedia=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),loadMedia=_useState8[0],setLoadMedia=_useState8[1];var refDisplay=useRef();var pageEnd=useRef();var _useState9=useState([]),_useState10=_slicedToArray(_useState9,2),data=_useState10[0],setData=_useState10[1];var _useState11=useState(9),_useState12=_slicedToArray(_useState11,2),result=_useState12[0],setResult=_useState12[1];var _useState13=useState(0),_useState14=_slicedToArray(_useState13,2),page=_useState14[0],setPage=_useState14[1];var _useState15=useState(0),_useState16=_slicedToArray(_useState15,2),isLoadMore=_useState16[0],setIsLoadMore=_useState16[1];var history=useHistory();useEffect(function(){var newData=message.data.find(function(item){return item._id===id;});if(newData){setData(newData.messages);setResult(newData.result);setPage(newData.page);}},[message.data,id]);useEffect(function(){if(id&&message.users.length>0){setTimeout(function(){refDisplay.current.scrollIntoView({behavior:'smooth',block:'end'});},50);var newUser=message.users.find(function(user){return user._id===id;});if(newUser)setUser(newUser);}},[message.users,id]);var handleChangeMedia=function handleChangeMedia(e){var files=_toConsumableArray(e.target.files);var err=\"\";var newMedia=[];files.forEach(function(file){if(!file)return err=\"File does not exist.\";if(file.size>1024*1024*5){return err=\"The image/video largest is 5mb.\";}return newMedia.push(file);});if(err)dispatch({type:GLOBALTYPES.ALERT,payload:{error:err}});setMedia([].concat(_toConsumableArray(media),newMedia));};var handleDeleteMedia=function handleDeleteMedia(index){var newArr=_toConsumableArray(media);newArr.splice(index,1);setMedia(newArr);};var handleSubmit=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){var newArr,msg;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:e.preventDefault();if(!(!text.trim()&&media.length===0)){_context.next=3;break;}return _context.abrupt(\"return\");case 3:setText('');setMedia([]);setLoadMedia(true);newArr=[];if(!(media.length>0)){_context.next=11;break;}_context.next=10;return imageUpload(media);case 10:newArr=_context.sent;case 11:msg={sender:auth.user._id,recipient:id,text:text,media:newArr,createdAt:new Date().toISOString()};setLoadMedia(false);_context.next=15;return dispatch(addMessage({msg:msg,auth:auth,socket:socket}));case 15:if(refDisplay.current){refDisplay.current.scrollIntoView({behavior:'smooth',block:'end'});}case 16:case\"end\":return _context.stop();}}},_callee);}));return function handleSubmit(_x){return _ref.apply(this,arguments);};}();useEffect(function(){var getMessagesData=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!message.data.every(function(item){return item._id!==id;})){_context2.next=4;break;}_context2.next=3;return dispatch(getMessages({auth:auth,id:id}));case 3:setTimeout(function(){refDisplay.current.scrollIntoView({behavior:'smooth',block:'end'});},50);case 4:case\"end\":return _context2.stop();}}},_callee2);}));return function getMessagesData(){return _ref2.apply(this,arguments);};}();getMessagesData();},[id,dispatch,auth,message.data]);// Load More\nuseEffect(function(){var observer=new IntersectionObserver(function(entries){if(entries[0].isIntersecting){setIsLoadMore(function(p){return p+1;});}},{threshold:0.1});observer.observe(pageEnd.current);},[setIsLoadMore]);useEffect(function(){if(isLoadMore>1){if(result>=page*9){dispatch(loadMoreMessages({auth:auth,id:id,page:page+1}));setIsLoadMore(1);}}// eslint-disable-next-line\n},[isLoadMore]);var handleDeleteConversation=function handleDeleteConversation(){if(window.confirm('Do you want to delete?')){dispatch(deleteConversation({auth:auth,id:id}));return history.push('/message');}};// Call\nvar caller=function caller(_ref3){var video=_ref3.video;var _id=user._id,avatar=user.avatar,username=user.username,fullname=user.fullname;var msg={sender:auth.user._id,recipient:_id,avatar:avatar,username:username,fullname:fullname,video:video};dispatch({type:GLOBALTYPES.CALL,payload:msg});};var callUser=function callUser(_ref4){var video=_ref4.video;var _auth$user=auth.user,_id=_auth$user._id,avatar=_auth$user.avatar,username=_auth$user.username,fullname=_auth$user.fullname;var msg={sender:_id,recipient:user._id,avatar:avatar,username:username,fullname:fullname,video:video};if(peer.open)msg.peerId=peer._id;socket.emit('callUser',msg);};var handleAudioCall=function handleAudioCall(){caller({video:false});callUser({video:false});};var handleVideoCall=function handleVideoCall(){caller({video:true});callUser({video:true});};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"message_header\",style:{cursor:'pointer'},children:user.length!==0&&/*#__PURE__*/_jsx(UserCard,{user:user,children:/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-phone-alt\"}),/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-phone-alt\",onClick:handleAudioCall}),/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-video mx-3\",onClick:handleVideoCall}),/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-trash text-danger\",onClick:handleDeleteConversation})]})})}),/*#__PURE__*/_jsx(\"div\",{className:\"chat_container\",style:{height:media.length>0?'calc(100% - 180px)':''},children:/*#__PURE__*/_jsxs(\"div\",{className:\"chat_display\",ref:refDisplay,children:[/*#__PURE__*/_jsx(\"button\",{style:{marginTop:'-25px',opacity:0},ref:pageEnd,children:\"Load more\"}),data.map(function(msg,index){return/*#__PURE__*/_jsxs(\"div\",{children:[msg.sender!==auth.user._id&&/*#__PURE__*/_jsx(\"div\",{className:\"chat_row other_message\",children:/*#__PURE__*/_jsx(MsgDisplay,{user:user,msg:msg,theme:theme})}),msg.sender===auth.user._id&&/*#__PURE__*/_jsx(\"div\",{className:\"chat_row you_message\",children:/*#__PURE__*/_jsx(MsgDisplay,{user:auth.user,msg:msg,theme:theme,data:data})})]},index);}),loadMedia&&/*#__PURE__*/_jsx(\"div\",{className:\"chat_row you_message\",children:/*#__PURE__*/_jsx(\"img\",{src:LoadIcon,alt:\"loading\"})})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"show_media\",style:{display:media.length>0?'grid':'none'},children:media.map(function(item,index){return/*#__PURE__*/_jsxs(\"div\",{id:\"file_media\",children:[item.type.match(/video/i)?videoShow(URL.createObjectURL(item),theme):imageShow(URL.createObjectURL(item),theme),/*#__PURE__*/_jsx(\"span\",{onClick:function onClick(){return handleDeleteMedia(index);},children:\"\\xD7\"})]},index);})}),/*#__PURE__*/_jsxs(\"form\",{className:\"chat_input\",onSubmit:handleSubmit,children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:\"Enter you message...\",value:text,onChange:function onChange(e){return setText(e.target.value);},style:{filter:theme?'invert(1)':'invert(0)',background:theme?'#040404':'',color:theme?'white':''}}),/*#__PURE__*/_jsx(Icons,{setContent:setText,content:text,theme:theme}),/*#__PURE__*/_jsxs(\"div\",{className:\"file_upload\",children:[/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-image text-danger\"}),/*#__PURE__*/_jsx(\"input\",{type:\"file\",name:\"file\",id:\"file\",multiple:true,accept:\"image/*,video/*\",onChange:handleChangeMedia})]}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"material-icons\",disabled:text||media.length>0?false:true,children:\"near_me\"})]})]});};export default RightSide;","map":{"version":3,"sources":["H:/Mern Stack Projects/WebApp/server/client/src/components/message/RightSide.jsx"],"names":["React","useState","useEffect","useRef","UserCard","useSelector","useDispatch","useParams","useHistory","MsgDisplay","Icons","GLOBALTYPES","imageShow","videoShow","imageUpload","addMessage","getMessages","loadMoreMessages","deleteConversation","LoadIcon","RightSide","state","auth","message","theme","socket","peer","dispatch","id","user","setUser","text","setText","media","setMedia","loadMedia","setLoadMedia","refDisplay","pageEnd","data","setData","result","setResult","page","setPage","isLoadMore","setIsLoadMore","history","newData","find","item","_id","messages","users","length","setTimeout","current","scrollIntoView","behavior","block","newUser","handleChangeMedia","e","files","target","err","newMedia","forEach","file","size","push","type","ALERT","payload","error","handleDeleteMedia","index","newArr","splice","handleSubmit","preventDefault","trim","msg","sender","recipient","createdAt","Date","toISOString","getMessagesData","every","observer","IntersectionObserver","entries","isIntersecting","p","threshold","observe","handleDeleteConversation","window","confirm","caller","video","avatar","username","fullname","CALL","callUser","open","peerId","emit","handleAudioCall","handleVideoCall","cursor","height","marginTop","opacity","map","display","match","URL","createObjectURL","value","filter","background","color"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useRef } from 'react'\nimport UserCard from '../UserCard'\nimport { useSelector, useDispatch } from 'react-redux'\nimport { useParams, useHistory } from 'react-router-dom'\nimport MsgDisplay from './MsgDisplay'\nimport Icons from '../Icons'\nimport { GLOBALTYPES } from '../../redux/actions/globalTypes'\nimport { imageShow, videoShow } from '../../utils/mediaShow'\nimport { imageUpload } from '../../utils/imageUpload'\nimport { addMessage, getMessages, loadMoreMessages, deleteConversation } from '../../redux/actions/messageAction'\nimport LoadIcon from '../../images/loading.gif'\n\nconst RightSide = () => {\n    const { auth, message, theme, socket, peer } = useSelector(state => state)\n    const dispatch = useDispatch()\n\n    const { id } = useParams()\n    const [user, setUser] = useState([])\n    const [text, setText] = useState('')\n    const [media, setMedia] = useState([])\n    const [loadMedia, setLoadMedia] = useState(false)\n\n    const refDisplay = useRef()\n    const pageEnd = useRef()\n\n    const [data, setData] = useState([])\n    const [result, setResult] = useState(9)\n    const [page, setPage] = useState(0)\n    const [isLoadMore, setIsLoadMore] = useState(0)\n\n    const history = useHistory()\n\n    useEffect(() => {\n        const newData = message.data.find(item => item._id === id)\n        if(newData){\n            setData(newData.messages)\n            setResult(newData.result)\n            setPage(newData.page)\n        }\n    },[message.data, id])\n\n    useEffect(() => {\n        if(id && message.users.length > 0){\n            setTimeout(() => {\n                refDisplay.current.scrollIntoView({behavior: 'smooth', block: 'end'})\n            },50)\n\n            const newUser = message.users.find(user => user._id === id)\n            if(newUser) setUser(newUser)\n        }\n    }, [message.users, id])\n\n    const handleChangeMedia = (e) => {\n        const files = [...e.target.files]\n        let err = \"\"\n        let newMedia = []\n\n        files.forEach(file => {\n            if(!file) return err = \"File does not exist.\"\n\n            if(file.size > 1024 * 1024 * 5){\n                return err = \"The image/video largest is 5mb.\"\n            }\n\n            return newMedia.push(file)\n        })\n\n        if(err) dispatch({ type: GLOBALTYPES.ALERT, payload: {error: err} })\n        setMedia([...media, ...newMedia])\n    }\n\n    const handleDeleteMedia = (index) => {\n        const newArr = [...media]\n        newArr.splice(index, 1)\n        setMedia(newArr)\n    }\n\n    const handleSubmit = async (e) => {\n        e.preventDefault()\n        if(!text.trim() && media.length === 0) return;\n        setText('')\n        setMedia([])\n        setLoadMedia(true)\n\n        let newArr = [];\n        if(media.length > 0) newArr = await imageUpload(media)\n\n        const msg = {\n            sender: auth.user._id,\n            recipient: id,\n            text, \n            media: newArr,\n            createdAt: new Date().toISOString()\n        }\n\n        setLoadMedia(false)\n        await dispatch(addMessage({msg, auth, socket}))\n        if(refDisplay.current){\n            refDisplay.current.scrollIntoView({behavior: 'smooth', block: 'end'})\n        }\n    }\n\n    useEffect(() => {\n        const getMessagesData = async () => {\n            if(message.data.every(item => item._id !== id)){\n                await dispatch(getMessages({auth, id}))\n                setTimeout(() => {\n                    refDisplay.current.scrollIntoView({behavior: 'smooth', block: 'end'})\n                },50)\n            }\n        }\n        getMessagesData()\n    },[id, dispatch, auth, message.data])\n\n\n    // Load More\n    useEffect(() => {\n        const observer = new IntersectionObserver(entries => {\n            if(entries[0].isIntersecting){\n                setIsLoadMore(p => p + 1)\n            }\n        },{\n            threshold: 0.1\n        })\n\n        observer.observe(pageEnd.current)\n    },[setIsLoadMore])\n\n    useEffect(() => {\n        if(isLoadMore > 1){\n            if(result >= page * 9){\n                dispatch(loadMoreMessages({auth, id, page: page + 1}))\n                setIsLoadMore(1)\n            }\n        }\n        // eslint-disable-next-line\n    },[isLoadMore])\n\n    const handleDeleteConversation = () => {\n        if(window.confirm('Do you want to delete?')){\n            dispatch(deleteConversation({auth, id}))\n            return history.push('/message')\n        }\n    }\n\n    // Call\n    const caller = ({video}) => {\n        const { _id, avatar, username, fullname } = user\n\n        const msg = {\n            sender: auth.user._id,\n            recipient: _id, \n            avatar, username, fullname, video\n        }\n        dispatch({ type: GLOBALTYPES.CALL, payload: msg })\n    }\n\n    const callUser = ({video}) => {\n        const { _id, avatar, username, fullname } = auth.user\n\n        const msg = {\n            sender: _id,\n            recipient: user._id, \n            avatar, username, fullname, video\n        }\n\n        if(peer.open) msg.peerId = peer._id\n\n        socket.emit('callUser', msg)\n    }\n\n    const handleAudioCall = () => {\n        caller({video: false})\n        callUser({video: false})\n    }\n    \n    const handleVideoCall = () => {\n        caller({video: true})\n        callUser({video: true})\n    }\n\n    \n\n    return (\n        <>\n            <div className=\"message_header\" style={{cursor: 'pointer'}} >\n                {\n                    user.length !== 0 &&\n                    <UserCard user={user}>\n                        <div>\n\n                        <i className=\"fas fa-phone-alt\" \n                         />\n\n                            <i className=\"fas fa-phone-alt\"\n                            onClick={handleAudioCall} />\n\n                            <i className=\"fas fa-video mx-3\"\n                            onClick={handleVideoCall} />\n\n                            <i className=\"fas fa-trash text-danger\"\n                            onClick={handleDeleteConversation} />\n                        </div>\n                    </UserCard>\n                }\n            </div>\n\n            <div className=\"chat_container\" \n            style={{height: media.length > 0 ? 'calc(100% - 180px)' : ''}} >\n                <div className=\"chat_display\" ref={refDisplay}>\n                    <button style={{marginTop: '-25px', opacity: 0}} ref={pageEnd}>\n                        Load more\n                    </button>\n\n                    {\n                        data.map((msg, index) => (\n                                <div key={index}>\n                                    {\n                                        msg.sender !== auth.user._id &&\n                                        <div className=\"chat_row other_message\">\n                                            <MsgDisplay user={user} msg={msg} theme={theme} />\n                                        </div>\n                                    }\n\n                                    {\n                                        msg.sender === auth.user._id &&\n                                        <div className=\"chat_row you_message\">\n                                            <MsgDisplay user={auth.user} msg={msg} theme={theme} data={data} />\n                                        </div>\n                                    }\n                                </div>\n                        ))\n                    }\n                    \n\n                   {\n                       loadMedia && \n                       <div className=\"chat_row you_message\">\n                           <img src={LoadIcon} alt=\"loading\"/>\n                       </div>\n                   }\n\n                </div>\n            </div>\n\n            <div className=\"show_media\" style={{display: media.length > 0 ? 'grid' : 'none'}} >\n                {\n                    media.map((item, index) => (\n                        <div key={index} id=\"file_media\">\n                            {\n                                item.type.match(/video/i)\n                                ? videoShow(URL.createObjectURL(item), theme)\n                                : imageShow(URL.createObjectURL(item), theme)\n                            }\n                            <span onClick={() => handleDeleteMedia(index)} >&times;</span>\n                        </div>\n                    ))\n                }\n            </div>\n\n            <form className=\"chat_input\" onSubmit={handleSubmit} >\n                <input type=\"text\" placeholder=\"Enter you message...\"\n                value={text} onChange={e => setText(e.target.value)}\n                style={{\n                    filter: theme ? 'invert(1)' : 'invert(0)',\n                    background: theme ? '#040404' : '',\n                    color: theme ? 'white' : ''\n                }} />\n\n                <Icons setContent={setText} content={text} theme={theme} />\n\n                <div className=\"file_upload\">\n                    <i className=\"fas fa-image text-danger\" />\n                    <input type=\"file\" name=\"file\" id=\"file\"\n                    multiple accept=\"image/*,video/*\" onChange={handleChangeMedia} />\n                </div>\n\n                <button type=\"submit\" className=\"material-icons\" \n                disabled={(text || media.length > 0) ? false : true}>\n                    near_me\n                </button>\n            </form>\n        </>\n    )\n}\n\nexport default RightSide"]},"metadata":{},"sourceType":"module"}